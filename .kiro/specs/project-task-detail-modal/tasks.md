# 实现计划：项目任务详情弹窗

## 概述

本实现计划将为项目详情页面的任务模块添加任务详情弹窗功能。实现将复用任务大厅页面的 TaskDetailModal 设计模式，但需要适配项目详情页面的特殊需求（创建者管理权限）。实现将采用增量方式，先创建基础模态框组件，然后添加内容展示，最后集成操作按钮和交互功能。

## 任务

- [x] 1. 创建 TaskDetailModal 组件基础结构
  - 在 `src/components/` 目录下创建 `TaskDetailModal.tsx` 文件
  - 定义 `TaskDetailModalProps` 接口，包含所有必需的 props
  - 实现模态框的基础布局（遮罩层、内容容器、关闭按钮）
  - 实现背景滚动控制逻辑（useEffect 钩子）
  - 实现点击遮罩层和关闭按钮关闭模态框的功能
  - _需求：1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 1.1 编写 TaskDetailModal 基础结构的单元测试
  - 测试模态框渲染
  - 测试关闭按钮点击事件
  - 测试遮罩层点击事件
  - 测试背景滚动控制副作用
  - _需求：1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. 实现任务内容展示区域
  - [x] 2.1 实现参考图片展示
    - 添加图片网格布局
    - 实现条件渲染（仅当有图片时显示）
    - 应用图片样式（圆角、最大高度、宽高比保持）
    - _需求：2.1, 8.1_
  
  - [x] 2.2 实现任务文本信息展示
    - 展示完整提示词
    - 展示任务要求（条件渲染）
    - 应用文本样式和背景
    - _需求：2.2, 2.3_
  
  - [x] 2.3 实现任务元信息展示
    - 创建元信息网格布局
    - 展示创建者邮箱、任务时长、项目名称、项目分类
    - 应用卡片样式
    - _需求：2.4, 2.5, 2.6, 2.7_

- [ ]* 2.4 编写内容展示的属性测试
  - **属性 3：任务内容完整展示**
  - **验证需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7**
  - 使用 fast-check 生成随机任务数据
  - 验证所有必需字段都被正确渲染
  - 验证可选字段的条件渲染
  - 最少 100 次迭代

- [x] 3. 实现复制功能
  - [x] 3.1 创建通用复制处理函数
    - 实现 `handleCopy` 函数，使用 navigator.clipboard.writeText
    - 添加错误处理（try-catch）
    - 集成 toast 提示（成功/失败）
    - _需求：3.1, 3.2, 3.3, 3.4_
  
  - [x] 3.2 为可复制字段添加复制按钮
    - 在提示词区域添加复制按钮
    - 在任务要求区域添加复制按钮（条件渲染）
    - 在创建者邮箱区域添加复制按钮
    - 应用按钮样式和图标
    - _需求：3.1, 3.2, 3.3_

- [ ]* 3.3 编写复制功能的单元测试
  - 测试复制按钮点击事件
  - Mock navigator.clipboard.writeText
  - 验证成功和失败场景的 toast 提示
  - _需求：3.1, 3.2, 3.3, 3.4_

- [x] 4. 检查点 - 确保基础功能正常
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 实现操作按钮区域
  - [x] 5.1 实现创建者操作按钮
    - 添加编辑按钮（草稿状态）
    - 添加删除按钮（草稿状态）
    - 添加发布按钮（草稿状态）
    - 添加完成按钮（已发布状态）
    - 实现条件渲染逻辑（基于 isCreator 和 task.status）
    - 连接回调函数（onEdit, onDelete, onPublish, onComplete）
    - _需求：4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9_
  
  - [x] 5.2 实现普通用户接受任务按钮
    - 添加接受任务按钮（非创建者 + 已发布状态）
    - 实现已接受状态的禁用按钮
    - 连接 onAccept 回调函数
    - _需求：5.1, 5.2, 5.3, 5.4_

- [ ]* 5.3 编写操作按钮的属性测试
  - **属性 5：创建者权限按钮显示**
  - **验证需求：4.1, 4.2, 4.3, 4.4**
  - 生成不同状态的任务和用户角色组合
  - 验证正确的按钮组合被显示
  - 最少 100 次迭代

- [ ]* 5.4 编写操作按钮回调的单元测试
  - 测试编辑按钮点击调用 onEdit 和 onClose
  - 测试删除按钮点击调用 onDelete
  - 测试发布按钮点击调用 onPublish
  - 测试完成按钮点击调用 onComplete 和 onClose
  - 测试接受按钮点击调用 onAccept
  - _需求：4.5, 4.7, 4.8, 4.9, 5.2_

- [x] 6. 集成到项目详情页面
  - [x] 6.1 在 ProjectDetailPage 中添加状态管理
    - 添加 `selectedTask` 状态
    - 添加 `showTaskDetailModal` 状态
    - 创建 `handleTaskCardClick` 函数
    - _需求：1.1_
  
  - [x] 6.2 修改 TaskCard 组件支持点击事件
    - 为 TaskCard 添加 `onClick` prop（可选）
    - 在 TaskCard 根元素上添加点击事件处理
    - 添加鼠标悬停样式提示可点击
    - _需求：1.1_
  
  - [x] 6.3 在 ProjectDetailPage 中渲染 TaskDetailModal
    - 导入 TaskDetailModal 组件
    - 在任务列表区域后添加 TaskDetailModal
    - 传递所有必需的 props
    - 连接现有的操作处理函数（handleEditTask, handleDeleteTask 等）
    - _需求：1.1, 4.5, 4.7, 4.8, 4.9, 5.2_

- [ ]* 6.4 编写集成测试
  - 测试从 TaskCard 点击到 TaskDetailModal 显示的完整流程
  - 测试模态框操作与父组件状态更新的集成
  - 测试不同用户角色的完整交互流程
  - _需求：1.1, 4.5, 4.7, 4.8, 4.9, 5.2_

- [x] 7. 添加可访问性和优化
  - [x] 7.1 实现键盘导航支持
    - 添加 ESC 键关闭模态框的事件监听
    - 实现焦点管理（模态框打开时移动焦点）
  
  - [x] 7.2 添加 ARIA 标签和语义化标记
    - 为关闭按钮添加 aria-label
    - 为图片添加有意义的 alt 文本
    - 为模态框添加 role="dialog"
  
  - [x] 7.3 优化性能
    - 在父组件中使用 useCallback 包裹回调函数
    - 为图片添加 loading="lazy" 属性

- [x] 8. 最终检查点 - 确保所有功能完整
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边缘情况
